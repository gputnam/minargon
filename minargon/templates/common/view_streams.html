{% import "stream_options_macro.html" | common as stream_options %}

{% extends "layout.html" | front_ended %}
{% block title %}Stream: {{ID}}{% endblock %}
{% block body %}
{{ super() }}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/bootstrap-only-glyphicons.css') }}" media="screen">
<div class="container">
<div class="row">
    <div class="col-md-4">
        <div class="row">
        <div class="card">
            <div class="card-header">Display Options</div>
            <div class="card-body">
                <form class="form" role="form">
                    {{ stream_options.time_range("start", "end", "toggle") }}
                    {{ stream_options.download("download") }}
	        </form>
            </div>
        </div>
        </div>
        <br>
        <div class="row">
         <div class="card">
             <div class="card-header">Data Select</div>
	     <div class="card-body">
                <form class="form" role="form">
	   	    {{ stream_options.tree_select([tree], "tree") }}
		</form>
	    </div>
	</div>
    </div>
    </div>
    <div class="col-md-8">
	<!-- plotly div -->
	<div style="padding:0" id="plotly-timeseries"></div>
    </div>
</div>
{%endblock%}
{% block script %}
<script defer type="module">
import * as module from "{{ url_for('static', filename='js/minargon/timeseries.js') }}";
// build the links
var link = new module.Data.D3DataLink(new module.DataLink.PostgresStreamLink($SCRIPT_ROOT, "{{database}}", "{{ID}}"));
var links = [];
var configs = [];
var names = [];
{% for (ID, database, config) in postgres_streams %}
    links.push(new module.Data.D3DataLink(new module.DataLink.PostgresStreamLink($SCRIPT_ROOT, "{{database}}", "{{ID}}")));
    configs.push({{config|tojson}});
    {% if "yTitle" in config %}
      names.push("{{config['yTitle']}}");
    {% else %}
      names.push("{{ID}}");
    {% endif %}
{% endfor %}
{% for (key, database, config) in redis_streams %}
    links.push(new module.Data.D3DataLink(new module.DataLink.SingleStreamLink($SCRIPT_ROOT + '/{{database}}', "{{key}}")));
    configs.push({{config|tojson}});
    names.push("{{key}}");
{% endfor %}

if (links.length > 0) {
  // build plotly controller
  var plotly_controller = new module.PlotlyController("plotly-timeseries", links[0], [configs[0]['yTitle']], configs[0])
    .timeRangeController("#start", "#end", "#toggle")
    .downloadDataController("#download");
  // add the other links
  for (var i = 1; i < links.length; i++) {
    plotly_controller.addLink(links[i], configs[i], names[i]); 
  }

  // start it
  plotly_controller.run();
  
}
else {
  alert("No Data Streams to Display");
}
</script>
{% endblock %}
